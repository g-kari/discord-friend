# MCPサーバー自動接続機能 - テストガイド

このドキュメントは、MCPサーバー自動接続機能のテスト手順を提供します。

## 環境設定

1. 以下の設定で `.env` ファイルを作成：
   ```
   DISCORD_BOT_TOKEN=your_bot_token
   DIFY_API_KEY=your_dify_api_key
   OPENAI_API_KEY=your_openai_api_key
   MCP_SERVERS={"サーバー名": ["ボイスチャンネル1", "ボイスチャンネル2"]}
   ```

   注意：「サーバー名」を実際のDiscordサーバー名に、「ボイスチャンネル1」「ボイスチャンネル2」をボットが自動的に参加するボイスチャンネル名に置き換えてください。

## テストケース

### 1. 基本的な自動接続

**手順:**
1. 上記のようにMCP_SERVERS環境変数を設定
2. ボットを起動
3. ログで自動接続メッセージを確認

**期待される結果:**
- ボットは「MCPサーバーへの自動接続を開始します」をログに記録するはず
- ボットは指定されたチャンネルへの接続を試みるはず
- 接続成功時、ボットは「ボイスチャンネル「チャンネル名」に自動接続しました」をログに記録するはず

### 2. 無効なチャンネル名

**手順:**
1. 存在しないチャンネル名でMCP_SERVERSを設定
2. ボットを起動

**期待される結果:**
- ボットはチャンネルが見つからないという警告メッセージをログに記録するはず
- エラーがあってもボットは正常に動作し続けるはず

### 3. コマンドテスト

#### /add_mcp_server コマンド

**手順:**
1. ボイスチャンネルに参加
2. `/add_mcp_server` コマンドを実行
3. `/add_mcp_server add_to_config:true` コマンドを実行

**期待される結果:**
- 最初のコマンドはチャンネルをメモリ内リストに追加するはず
- 2番目のコマンドはチャンネルを.envファイルに追加するはず
- ボットはアクションを確認するメッセージで応答するはず

#### /list_mcp_servers コマンド

**手順:**
1. いくつかのMCPサーバーを設定
2. `/list_mcp_servers` コマンドを実行

**期待される結果:**
- ボットは自動接続リスト内のサーバーとチャンネルのリストで応答するはず

#### /remove_mcp_server コマンド

**手順:**
1. いくつかのMCPサーバーを設定
2. `/remove_mcp_server` コマンドを実行（現在のサーバーとチャンネルを使用）
3. `/remove_mcp_server server_name:"サーバー名" channel_name:"チャンネル名"` コマンドを実行
4. `/remove_mcp_server remove_from_config:true` コマンドを実行

**期待される結果:**
- 最初のコマンドは現在のチャンネルをメモリ内リストから削除するはず
- 2番目のコマンドは指定されたサーバーから指定されたチャンネルを削除するはず
- 3番目のコマンドはチャンネルを削除し.envファイルを更新するはず
- ボットは各アクションを確認するメッセージで応答するはず

## トラブルシューティング

自動接続機能が期待通りに動作しない場合：

1. ボットのログでエラーメッセージを確認
2. MCP_SERVERS環境変数のJSON形式が正しいことを確認
3. ボットが指定されたボイスチャンネルに参加する権限を持っていることを確認
4. サーバー名とチャンネル名が完全に一致していることを確認（大文字小文字区別）